---
   layout: default
　　title: 谈谈promise
---
##谈谈promise
这一篇中，我们来谈一谈jQuery中的promise。

1. jQuery中promise的用法：

最常见的用法是在Ajax中，通过阅读api，我们发现，在jQuery 1.5版本之前，$.ajax()返回了一个 jQuery XMLHttpRequest (jqXHR) object；1.5版本之后，则返回了一个promise对象。于是我们可以这么去使用。done(),fail(),always()方法，分别对应了参数success, error, complete。
<pre><code>var jqxhr = $.ajax( "example.php" )
  .done(function() {
    alert( "success" );
  })
  .fail(function() {
    alert( "error" );
  })
  .always(function() {
    alert( "complete" );
  }); 
</code></pre>

ok,现在我们已经知道如何在Ajax中使用promise，但是其他的异步操作怎么去使用promise呢，这就涉及到了jQuery中的Deferred对象,我们看下jQuery Api中对Deferred的说明：

The Deferred object, introduced in jQuery 1.5, is a chainable utility object created by calling the jQuery.Deferred() method. It can register multiple callbacks into callback queues, invoke callback queues, and relay the success or failure state of any synchronous or asynchronous function.

The Deferred object is chainable, similar to the way a jQuery object is chainable, but it has its own methods. After creating a Deferred object, you can use any of the methods below by either chaining directly from the object creation or saving the object in a variable and invoking one or more methods on that variable.

我的理解是，jQuery的Deferred对象实现，类似于上篇中提到的原生javascript中的promise对象，OK，我们看看如何去使用这个Deferred对象。Deferred的部分方法：

（1） $.Deferred() 生成一个deferred对象。

（2） deferred.done() 指定操作成功时的回调函数

（3） deferred.fail() 指定操作失败时的回调函数

（4） deferred.promise() 没有参数时，返回一个新的deferred对象，该对象的运行状态无法被改变；接受参数时，作用为在参数对象上部署deferred接口。

（5） deferred.resolve() 手动改变deferred对象的运行状态为"已完成"，从而立即触发done()方法。

（6） deferred.reject() 这个方法与deferred.resolve()正好相反，调用后将deferred对象的运行状态变为"已失败"，从而立即触发fail()方法。

（7） $.when() 为多个操作指定回调函数。

（8） deferred.then() 有时为了省事，可以把done()和fail()合在一起写，这就是then()方法。

（9） deferred.always()这个方法也是用来指定回调函数的，它的作用是，不管调用的是deferred.resolve()还是deferred.reject()，最后总是执行。

现在我们来尝试改写上一篇中最后的代码

<pre><code>var money = 4;
var buy = function(goods){
    if (money > 0){
      console.log('恭喜，您成功购买了'+ goods);
      money--;
      return;
    }
    console.log('亲，余额不足了呦~');
};

var def = $.Deferred();

def.then(buy('书'))
   .then(buy('衣服'))
   .then(buy('食品'))
   .then(buy('房子'))
   .then(buy('买买买'));
</code></pre>
